<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account - BurgTV</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0b;--bg-secondary:#111113;--text:#fff;--text-secondary:#a0a0a8;--accent:#B94A8E;--accent-light:#d85aa3;--accent-dark:#7B4397;--success:#10b981;--error:#ef4444;--border:rgba(255,255,255,0.12);--card-bg:rgba(255,255,255,0.03);--card-hover:rgba(255,255,255,0.06)}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .header{background:rgba(10,10,20,.95);backdrop-filter:blur(10px);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100}
        .header-inner{max-width:600px;margin:0 auto;height:64px;display:flex;align-items:center;justify-content:space-between}
        .logo{height:40px;width:auto}
        .back-link{display:flex;align-items:center;gap:8px;color:var(--text-secondary);text-decoration:none;font-size:14px}
        .back-link:hover{color:var(--text)}
        .back-link svg{width:18px;height:18px;stroke:currentColor;stroke-width:2;fill:none}
        .main{max-width:600px;margin:0 auto;padding:40px 20px}
        .page-title{font-size:28px;font-weight:700;margin-bottom:8px}
        .page-subtitle{color:var(--text-secondary);font-size:15px;margin-bottom:40px}
        .section{margin-bottom:32px}
        .section-title{font-size:13px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:16px}
        .btn{width:100%;padding:16px 20px;border-radius:12px;font-size:16px;font-family:'Inter',sans-serif;font-weight:600;display:flex;align-items:center;justify-content:center;gap:12px;cursor:pointer;transition:all 0.3s ease;border:none;margin-bottom:12px}
        .btn svg{width:20px;height:20px;stroke:currentColor;stroke-width:2;fill:none}
        .btn-primary{background:var(--accent);color:white}
        .btn-primary:hover{background:var(--accent-light);transform:translateY(-2px)}
        .btn-secondary{background:var(--card-hover);color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{background:rgba(185,74,142,0.1);border-color:var(--accent)}
        .btn-danger{background:transparent;color:var(--error);border:1px solid rgba(239,68,68,0.3)}
        .btn-danger:hover{background:rgba(239,68,68,0.1);border-color:var(--error)}
        .info-card{background:var(--card-bg);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px}
        .info-label{font-size:13px;color:var(--text-secondary);margin-bottom:4px}
        .info-value{font-size:16px;font-weight:500}
        .footer{text-align:center;padding:32px 20px;color:var(--text-secondary);font-size:13px}
        .footer a{color:var(--text-secondary);text-decoration:none;margin:0 10px}
        .footer a:hover{color:var(--accent)}
        .device-card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
        .device-info{display:flex;align-items:center;gap:12px}
        .device-icon{width:40px;height:40px;background:var(--card-hover);border-radius:10px;display:flex;align-items:center;justify-content:center}
        .device-icon svg{width:20px;height:20px;stroke:var(--accent);stroke-width:2;fill:none}
        .device-name{font-weight:600;font-size:15px;margin-bottom:2px}
        .device-code{font-size:12px;color:var(--text-secondary);font-family:monospace}
        .device-remove{background:transparent;border:1px solid rgba(239,68,68,0.3);color:var(--error);padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:6px}
        .device-remove:hover{background:rgba(239,68,68,0.1);border-color:var(--error)}
        .device-remove svg{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none}
        .no-devices{text-align:center;padding:24px;color:var(--text-secondary);font-size:14px}
        .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .lang-switch{position:fixed;top:1rem;right:1rem;display:flex;gap:0.4rem;z-index:1000;background:var(--card-bg);backdrop-filter:blur(10px);padding:0.4rem;border-radius:10px;border:1px solid var(--border)}
        .lang-btn{padding:0.4rem 0.8rem;background:transparent;color:var(--text-secondary);border:none;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:500;transition:all 0.3s}
        .lang-btn:hover{background:var(--card-hover);color:var(--text)}
        .lang-btn.active{background:var(--accent);color:#fff}
        @media(min-width:769px){.main{max-width:700px;padding:60px 40px}.page-title{font-size:36px}.page-subtitle{font-size:17px}.section-title{font-size:14px}.info-card{padding:24px}.info-label{font-size:14px}.info-value{font-size:18px}.btn{padding:18px 24px;font-size:17px;border-radius:14px}.header-inner{max-width:700px;height:72px}.logo{height:48px}}
        @media(min-width:1200px){.main{max-width:800px;padding:72px 48px}.page-title{font-size:40px}.btn{padding:20px 28px;font-size:18px}}
    </style>
</head>
<body>
    <div class="lang-switch">
        <button class="lang-btn active" data-lang="it">IT</button>
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="de">DE</button>
        <button class="lang-btn" data-lang="es">ES</button>
        <button class="lang-btn" data-lang="fr">FR</button>
    </div>
    <header class="header">
        <div class="header-inner">
            <a href="https://burgtv.com"><img src="logo.png" alt="BurgTV" class="logo"></a>
            <a href="index.html" class="back-link"><svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg><span>Dashboard</span></a>
        </div>
    </header>
    <main class="main">
        <h1 class="page-title">Account</h1>
        <p class="page-subtitle" id="userEmail"></p>
        <div class="section">
            <div class="section-title">Informazioni account</div>
            <div class="info-card"><div class="info-label">Email</div><div class="info-value" id="emailDisplay">-</div></div>
            <div class="info-card"><div class="info-label">Piano</div><div class="info-value" id="planDisplay">-</div></div>
        </div>
        <div class="section" id="subscriptionSection" style="display:none;">
            <div class="section-title">Abbonamento</div>
            <button class="btn btn-primary" onclick="manageSubscription()" id="manageSubBtn">
                <svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                <span>Gestisci abbonamento</span>
            </button>
            <p style="font-size:13px;color:var(--text-secondary);margin-top:8px;text-align:center;">Modifica metodo di pagamento o annulla</p>
        </div>
        <div class="section" id="devicesSection">
            <div class="section-title">I tuoi dispositivi (<span id="deviceCount">0/5</span>)</div>
            <div id="devicesList"></div>
            <p style="font-size:13px;color:var(--text-secondary);margin-top:12px;text-align:center;" id="devicesHint">Puoi usare fino a 5 dispositivi</p>
        </div>
        <div class="section">
            <div class="section-title">Sicurezza</div>
            <button class="btn btn-primary" onclick="resetPassword()">
                <svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                <span>Reimposta password</span>
            </button>
        </div>
        <div class="section">
            <div class="section-title">Sessione</div>
            <button class="btn btn-secondary" onclick="logout()">
                <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                <span>Esci</span>
            </button>
        </div>
        <div class="section">
            <div class="section-title">Zona pericolosa</div>
            <button class="btn btn-danger" onclick="deleteAccount()">
                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                <span>Elimina account</span>
            </button>
        </div>
    </main>
    <footer class="footer">
        <a href="legal/privacy.html">Privacy</a>
        <a href="legal/terms.html">Termini</a>
        <a href="mailto:info@burgtv.com">info@burgtv.com</a>
    </footer>
    <script>
        const SUPABASE_URL='https://ugspmqfduabfmfsoxqoc.supabase.co';
        const T={it:{title:'Account',dashboard:'Dashboard',info:'Informazioni account',email:'Email',plan:'Piano',devices:'I tuoi dispositivi',security:'Sicurezza',resetPwd:'Reimposta password',session:'Sessione',logout:'Esci',danger:'Zona pericolosa',deleteAcc:'Elimina account',confirm1:'Sei sicuro di voler eliminare il tuo account?',confirm2:'Conferma finale: tutti i dati verranno eliminati.',deleted:'Account eliminato.',error:'Errore. Contatta info@burgtv.com',noDevices:'Nessun dispositivo registrato',devicesHint:'Puoi usare fino a 5 dispositivi',remove:'Rimuovi'},en:{title:'Account',dashboard:'Dashboard',info:'Account info',email:'Email',plan:'Plan',devices:'Your devices',security:'Security',resetPwd:'Reset password',session:'Session',logout:'Log out',danger:'Danger zone',deleteAcc:'Delete account',confirm1:'Are you sure you want to delete your account?',confirm2:'Final confirmation: all data will be deleted.',deleted:'Account deleted.',error:'Error. Contact info@burgtv.com',noDevices:'No devices registered',devicesHint:'You can use up to 5 devices',remove:'Remove'},de:{title:'Konto',dashboard:'Dashboard',info:'Kontoinformationen',email:'E-Mail',plan:'Plan',devices:'Ihre Geräte',security:'Sicherheit',resetPwd:'Passwort zurücksetzen',session:'Sitzung',logout:'Abmelden',danger:'Gefahrenzone',deleteAcc:'Konto löschen',confirm1:'Möchten Sie Ihr Konto wirklich löschen?',confirm2:'Endgültige Bestätigung: Alle Daten werden gelöscht.',deleted:'Konto gelöscht.',error:'Fehler. Kontaktieren Sie info@burgtv.com',noDevices:'Keine Geräte registriert',devicesHint:'Sie können bis zu 5 Geräte nutzen',remove:'Entfernen'},es:{title:'Cuenta',dashboard:'Panel',info:'Información de cuenta',email:'Correo',plan:'Plan',devices:'Tus dispositivos',security:'Seguridad',resetPwd:'Restablecer contraseña',session:'Sesión',logout:'Cerrar sesión',danger:'Zona peligrosa',deleteAcc:'Eliminar cuenta',confirm1:'¿Estás seguro de que deseas eliminar tu cuenta?',confirm2:'Confirmación final: todos los datos serán eliminados.',deleted:'Cuenta eliminada.',error:'Error. Contacta info@burgtv.com',noDevices:'Ningún dispositivo registrado',devicesHint:'Puedes usar hasta 5 dispositivos',remove:'Eliminar'},fr:{title:'Compte',dashboard:'Tableau de bord',info:'Informations du compte',email:'Email',plan:'Plan',devices:'Vos appareils',security:'Sécurité',resetPwd:'Réinitialiser le mot de passe',session:'Session',logout:'Déconnexion',danger:'Zone dangereuse',deleteAcc:'Supprimer le compte',confirm1:'Êtes-vous sûr de vouloir supprimer votre compte?',confirm2:'Confirmation finale: toutes les données seront supprimées.',deleted:'Compte supprimé.',error:'Erreur. Contactez info@burgtv.com',noDevices:'Aucun appareil enregistré',devicesHint:'Vous pouvez utiliser jusqu\'à 5 appareils',remove:'Supprimer'}};
        let lang=localStorage.getItem('lang')||'it';
        function setLang(l){
            lang=l;
            localStorage.setItem('lang',l);
            document.querySelectorAll('.lang-btn').forEach(b=>b.classList.toggle('active',b.dataset.lang===l));
            document.querySelector('.page-title').textContent=T[l].title;
            document.querySelector('.back-link span').textContent=T[l].dashboard;
            // Update all section titles and buttons
            const sections=document.querySelectorAll('.section-title');
            if(sections[0])sections[0].textContent=T[l].info;
            if(sections[1])sections[1].innerHTML=T[l].devices+' (<span id="deviceCount">'+document.getElementById('deviceCount').textContent+'</span>)';
            document.getElementById('devicesHint').textContent=T[l].devicesHint;
            if(sections[2])sections[2].textContent=T[l].security;
            if(sections[3])sections[3].textContent=T[l].session;
            if(sections[4])sections[4].textContent=T[l].danger;
            // Labels
            document.querySelectorAll('.info-label')[0].textContent=T[l].email;
            document.querySelectorAll('.info-label')[1].textContent=T[l].plan;
            // Buttons
            document.querySelector('.btn-primary span').textContent=T[l].resetPwd;
            document.querySelector('.btn-secondary span').textContent=T[l].logout;
            document.querySelector('.btn-danger span').textContent=T[l].deleteAcc;
        }
        document.querySelectorAll('.lang-btn').forEach(b=>b.addEventListener('click',()=>setLang(b.dataset.lang)));
        document.addEventListener('DOMContentLoaded',function(){
            const email=localStorage.getItem('user_email')||'-';
            document.getElementById('emailDisplay').textContent=email;
            document.getElementById('userEmail').textContent=email;
            setLang(lang);
            checkSubscription();
            loadDevices();
        });
        function resetPassword(){window.location.href='forgot-password.html'}
        function logout(){localStorage.removeItem('session_token');localStorage.removeItem('user_email');localStorage.removeItem('user_id');localStorage.removeItem('license_type');localStorage.removeItem('license_status');window.location.href='login.html'}

        async function loadDevices(){
            const email=localStorage.getItem('user_email');
            if(!email)return;
            const list=document.getElementById('devicesList');
            list.innerHTML='<div style="text-align:center;padding:20px;"><span class="spinner"></span></div>';
            try{
                const res=await fetch(`${SUPABASE_URL}/functions/v1/get-devices`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnc3BtcWZkdWFiZm1mc294cW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1NTMyMDEsImV4cCI6MjA2MDEyOTIwMX0.1Xj4sa51Wi8U1Ebm4B3DE5JxCR3eTx2TQUxfV0TaA-I'},
                    body:JSON.stringify({email})
                });
                const data=await res.json();
                document.getElementById('deviceCount').textContent=data.slot||'0/5';
                if(data.devices && data.devices.length>0){
                    list.innerHTML=data.devices.map(d=>`
                        <div class="device-card">
                            <div class="device-info">
                                <div class="device-icon"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg></div>
                                <div>
                                    <div class="device-name">${d.device_name||'Dispositivo'}</div>
                                    <div class="device-code">${d.device_code||''}</div>
                                </div>
                            </div>
                            <button class="device-remove" onclick="removeDevice('${d.device_id}','${d.device_name||'Dispositivo'}')">
                                <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                Rimuovi
                            </button>
                        </div>
                    `).join('');
                }else{
                    list.innerHTML='<div class="no-devices">Nessun dispositivo registrato</div>';
                }
            }catch(e){
                console.error(e);
                list.innerHTML='<div class="no-devices">Errore nel caricamento</div>';
            }
        }

        async function removeDevice(deviceId,deviceName){
            if(!confirm(`Vuoi rimuovere "${deviceName}"?`))return;
            const email=localStorage.getItem('user_email');
            try{
                const res=await fetch(`${SUPABASE_URL}/functions/v1/remove-device`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnc3BtcWZkdWFiZm1mc294cW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1NTMyMDEsImV4cCI6MjA2MDEyOTIwMX0.1Xj4sa51Wi8U1Ebm4B3DE5JxCR3eTx2TQUxfV0TaA-I'},
                    body:JSON.stringify({email, device_id:deviceId})
                });
                const data=await res.json();
                if(data.success){
                    loadDevices();
                }else{
                    alert(data.error||'Errore nella rimozione');
                }
            }catch(e){
                alert('Errore di connessione');
            }
        }
        async function manageSubscription(){
            const email=localStorage.getItem('user_email');
            if(!email){alert('Email non trovata');return;}
            const btn=document.getElementById('manageSubBtn');
            btn.disabled=true;
            btn.innerHTML='<span class="spinner" style="width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;"></span>';
            try{
                const res=await fetch(`${SUPABASE_URL}/functions/v1/create-portal-session`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnc3BtcWZkdWFiZm1mc294cW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1NTMyMDEsImV4cCI6MjA2MDEyOTIwMX0.1Xj4sa51Wi8U1Ebm4B3DE5JxCR3eTx2TQUxfV0TaA-I'},
                    body:JSON.stringify({email})
                });
                const data=await res.json();
                if(data.portal_url){window.location.href=data.portal_url;}
                else{alert(data.error||'Errore');btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg><span>Gestisci abbonamento</span>';}
            }catch(e){alert('Errore di connessione');btn.disabled=false;btn.innerHTML='<svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg><span>Gestisci abbonamento</span>';}
        }
        async function checkSubscription(){
            const email=localStorage.getItem('user_email');
            if(!email)return;
            try{
                const res=await fetch(`${SUPABASE_URL}/functions/v1/verify-license`,{
                    method:'POST',
                    headers:{'Content-Type':'application/json','Authorization':'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnc3BtcWZkdWFiZm1mc294cW9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ1NTMyMDEsImV4cCI6MjA2MDEyOTIwMX0.1Xj4sa51Wi8U1Ebm4B3DE5JxCR3eTx2TQUxfV0TaA-I'},
                    body:JSON.stringify({email})
                });
                const data=await res.json();
                if(data.valid && data.license && data.license.license_type==='subscription'){
                    document.getElementById('subscriptionSection').style.display='block';
                    document.getElementById('planDisplay').textContent='Abbonamento Annuale';
                }else if(data.valid){
                    document.getElementById('planDisplay').textContent='Licenza Permanente';
                }
            }catch(e){console.error(e);}
        }
        async function deleteAccount(){
            if(!confirm(T[lang].confirm1))return;
            if(!confirm(T[lang].confirm2))return;
            const token=localStorage.getItem('access_token');
            try{await fetch(`${SUPABASE_URL}/functions/v1/delete-account`,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'}});localStorage.clear();alert(T[lang].deleted);window.location.href='https://burgtv.com'}catch(e){alert(T[lang].error)}
        }
    </script>
</body>
</html>
